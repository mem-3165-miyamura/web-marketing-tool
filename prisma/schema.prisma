generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum VisitorStatus {
  LEAD
  PROSPECT
  CUSTOMER
  CHURNED
}

model User {
  id             String        @id @default(cuid())
  name           String?
  email          String        @unique
  emailVerified  DateTime?
  image          String?
  hashedPassword String?
  popups         PopUpConfig[]
  mailConfigs    MailConfig[]
  visitors       Visitor[]     
  products       Product[]     // ç®¡ç†è€…ãŒç™»éŒ²ã—ãŸå•†å“ãƒã‚¹ã‚¿ãƒ¼ï¼ˆCMSæ©Ÿèƒ½ï¼‰
  
  statusRules    Json?         
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

model Visitor {
  id         String        @id @default(cuid())
  email      String        @unique
  name       String?
  lastVid    String        
  status     VisitorStatus @default(LEAD)
  
  userId     String
  user       User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  logs       TrackingLog[]
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  @@index([lastVid])
  @@index([userId])
}

// ğŸ›’ Headless CMSæ©Ÿèƒ½ã¨ã—ã¦ã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆãƒ¢ãƒ‡ãƒ«
model Product {
  id          String   @id @default(cuid())
  name        String   
  description String?  @db.Text
  price       Int      
  imageUrl    String   
  category    String   
  stock       Int      @default(0) 
  
  isPublished Boolean  @default(true)  // è²©å£²çµ‚äº†ãƒ»éå…¬é–‹ç®¡ç†
  isSale      Boolean  @default(false) // ã‚»ãƒ¼ãƒ«ãƒ©ãƒ™ãƒ«ç”¨
  priority    Int      @default(0)     // ãŠã™ã™ã‚é †ãªã©ã®ä¸¦ã³æ›¿ãˆç”¨
  campaignTag String?  // ã€Œå†¬ç‰©ã‚»ãƒ¼ãƒ«ã€ã€Œé™å®šå“ã€ãªã©ã®ã‚¿ã‚°

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([category])
}

model PopUpConfig {
  id           String        @id @default(cuid())
  name         String
  enabled      Boolean       @default(true)
  type         String        @default("standard")
  title        String
  description  String
  imageUrl     String?
  buttonText   String        @default("è©³ç´°ã‚’è¦‹ã‚‹")
  buttonLink   String        @default("#")
  titleB       String?
  descriptionB String?
  imageUrlB    String?
  buttonTextB  String?
  displayDelay Int           @default(3000)
  views        Int           @default(0)
  clicks       Int           @default(0)
  userId       String
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  TrackingLogs TrackingLog[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model MailConfig {
  id           String        @id @default(cuid())
  name         String
  enabled      Boolean       @default(true)
  targetStatus VisitorStatus
  triggerEvent String
  subject      String
  content      String        @db.Text
  templateType String        @default("B2B")
  imageUrl     String?
  userId       String
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([targetStatus, triggerEvent, enabled])
}

model TrackingLog {
  id           String       @id @default(cuid())
  popUpId      String?
  popUpConfig  PopUpConfig? @relation(fields: [popUpId], references: [id], onDelete: SetNull)
  userId       String
  visitorId    String?
  visitor      Visitor?     @relation(fields: [visitorId], references: [id])
  eventType    String
  pattern      String       @default("A")
  metadata     Json?
  siteId       String?
  pageUrl      String?      @db.VarChar(1000)
  createdAt    DateTime     @default(now())

  @@index([popUpId, eventType, pattern])
  @@index([userId])
  @@index([visitorId])
}