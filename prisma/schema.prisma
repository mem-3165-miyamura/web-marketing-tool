generator client {
  provider = "prisma-client-js"
}

// Prisma 7.2.0 以降の仕様: url プロパティを記述せず prisma.config.cjs 側で管理
datasource db {
  provider = "postgresql"
}

enum VisitorStatus {
  LEAD
  PROSPECT
  CUSTOMER
  CHURNED
}

model User {
  id             String        @id @default(cuid())
  name           String?
  email          String        @unique
  emailVerified  DateTime?
  image          String?
  hashedPassword String?
  popups         PopUpConfig[]
  mailConfigs    MailConfig[]
  visitors       Visitor[]     
  products       Product[]     // 管理者が登録した商品マスター
  
  statusRules    Json?         
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

model Visitor {
  id        String        @id @default(cuid())
  email     String        @unique
  name      String?
  lastVid   String        
  status    VisitorStatus @default(LEAD)
  
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  logs      TrackingLog[]
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([lastVid])
  @@index([userId])
}

// Headless CMS機能としてのプロダクトモデル
model Product {
  id          String   @id @default(cuid())
  name        String   
  description String?  @db.Text
  price       Int      
  imageUrl    String   
  category    String   
  stock       Int      @default(0) 
  
  isPublished Boolean  @default(true)  
  isSale      Boolean  @default(false) 
  priority    Int      @default(0)     
  campaignTag String?  

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([category])
}

model PopUpConfig {
  id           String        @id @default(cuid())
  name         String
  enabled      Boolean       @default(true)
  type         String        @default("standard")
  title        String
  description  String
  imageUrl     String?
  buttonText   String        @default("詳細を見る")
  buttonLink   String        @default("#")
  titleB       String?
  descriptionB String?
  imageUrlB    String?
  buttonTextB  String?
  displayDelay Int           @default(3000)
  views        Int           @default(0)
  clicks       Int           @default(0)
  userId       String
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  TrackingLogs TrackingLog[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model MailConfig {
  id           String        @id @default(cuid())
  name         String
  enabled      Boolean       @default(true)
  targetStatus VisitorStatus
  triggerEvent String
  subject      String
  content      String        @db.Text
  templateType String        @default("B2B")
  imageUrl     String?
  userId       String
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([targetStatus, triggerEvent, enabled])
}

model TrackingLog {
  id           String       @id @default(cuid())
  popUpId      String?
  popUpConfig  PopUpConfig? @relation(fields: [popUpId], references: [id], onDelete: SetNull)
  userId       String
  visitorId    String?
  visitor      Visitor?     @relation(fields: [visitorId], references: [id])
  eventType    String
  pattern      String       @default("A")
  metadata     Json?
  siteId       String?
  pageUrl      String?      @db.VarChar(1000)
  createdAt    DateTime     @default(now())

  @@index([popUpId, eventType, pattern])
  @@index([userId])
  @@index([visitorId])
}