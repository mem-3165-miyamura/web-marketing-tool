generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum VisitorStatus {
  LEAD
  PROSPECT
  CUSTOMER
  CHURNED
}

model User {
  id             String        @id @default(cuid())
  name           String?
  email          String        @unique
  emailVerified  DateTime?
  image          String?       // 認証エラー解消用
  hashedPassword String?
  popups         PopUpConfig[]
  mailConfigs    MailConfig[]
  visitors       Visitor[]     // 追加：管理者が持つ訪問者一覧
  
  // 追加：顧客ステータスの判定ルール
  statusRules    Json?         
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

model Visitor {
  id        String        @id @default(cuid())
  email     String        @unique
  name      String?
  lastVid   String        // 名寄せ用
  status    VisitorStatus @default(LEAD)
  
  // 追加：どの管理者に紐付くか
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  logs      TrackingLog[]
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([lastVid])
  @@index([userId])
}

model PopUpConfig {
  id           String        @id @default(cuid())
  name         String
  enabled      Boolean       @default(true)
  type         String        @default("standard")
  title        String
  description  String
  imageUrl     String?
  buttonText   String        @default("詳細を見る")
  buttonLink   String        @default("#")
  titleB       String?
  descriptionB String?
  imageUrlB    String?
  buttonTextB  String?
  displayDelay Int           @default(3000)
  views        Int           @default(0)
  clicks       Int           @default(0)
  userId       String
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  TrackingLogs TrackingLog[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model MailConfig {
  id           String        @id @default(cuid())
  name         String
  enabled      Boolean       @default(true)
  targetStatus VisitorStatus
  triggerEvent String
  subject      String
  content      String        @db.Text
  templateType String        @default("B2B")
  imageUrl     String?
  userId       String
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([targetStatus, triggerEvent, enabled])
}

model TrackingLog {
  id           String      @id @default(cuid())
  popUpId      String
  popUpConfig  PopUpConfig @relation(fields: [popUpId], references: [id], onDelete: Cascade)
  userId       String
  visitorId    String?
  visitor      Visitor?    @relation(fields: [visitorId], references: [id])
  eventType    String
  pattern      String      @default("A")
  metadata     Json?
  siteId       String?
  pageUrl      String?     @db.VarChar(1000)
  createdAt    DateTime    @default(now())

  @@index([popUpId, eventType, pattern])
  @@index([userId])
  @@index([visitorId])
}